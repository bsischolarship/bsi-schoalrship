<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Home | Inspirasi BSI Scholarship ‚Äî Batch 5</title>
<link rel="stylesheet" href="assets/style.css" />

<!-- ‚úÖ ADD-ON (TIDAK MENGHAPUS APA PUN): kolom fixed 100%, minibar full, dropdown suggestion, font mobile kecil -->
<style>
  /* ===== TABLE: pastikan layout kolom stabil & minibar tidak ‚Äúmemendek‚Äù ===== */
  .data-body table{
    width:100%;
    table-layout:fixed;
    border-collapse:collapse;
  }

  .data-body th, .data-body td{
    vertical-align:middle;
  }

  /* Lebar kolom sesuai permintaan: # 6%, Nama 44%, Hadir 20%, Perc. 30% */
  .data-body th:nth-child(1), .data-body td:nth-child(1){ width:15%;  text-align:center; }
  .data-body th:nth-child(2), .data-body td:nth-child(2){ width:45%; text-align:left; }
  .data-body th:nth-child(3), .data-body td:nth-child(3){ width:20%; text-align:center; }
  .data-body th:nth-child(4), .data-body td:nth-child(4){ width:20%; }

  /* Nama rata kiri + aman kalau panjang (tidak mengganggu minibar) */
  .data-body td:nth-child(2){
    text-align:left;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  /* ===== PROGRESS BAR: selalu 100% lebar kolom ===== */
  .progress-wrap{
    display:flex;
    align-items:center;
    gap:2px;
    width:100%;
  }
  .progress{
    position:relative;
    flex:1;
    width:100%;
    height:10px;
    border-radius:999px;
    overflow:hidden;
    background:#eee;
  }
  .percent{
    min-width:44px;
    text-align:right;
  }

  /* Warna minibar sesuai permintaan:
     - hijau untuk paling aktif
     - merah untuk kurang aktif
  */
  .good-bar{ height:100%; background:#1fbf75; }
  .bad-bar{  height:100%; background:#e55353; }

  /* ===== HEADER + SEARCH (kanan) ===== */
  .data-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .data-head .head-title{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .data-head .head-search{
    position:relative;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .data-head .head-search input{
    padding:8px 10px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,.15);
    outline:none;
    min-width:240px;
    max-width:340px;
    background:#fff;
  }
  .data-head .head-search input:focus{
    border-color: rgba(0,167,157,.6);
    box-shadow: 0 0 0 3px rgba(0,167,157,.12);
  }

  /* Dropdown suggestion */
  .search-dropdown{
    position:absolute;
    top:calc(100% + 6px);
    left:0;
    right:0;
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    border-radius:12px;
    overflow:hidden;
    z-index:999;
    max-height:260px;
    overflow-y:auto;
    box-shadow: 0 10px 24px rgba(0,0,0,.08);
  }
  .search-item{
    padding:10px 12px;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    gap:10px;
    font-size:13px;
    line-height:1.2;
  }
  .search-item:hover{
    background:rgba(0,167,157,.08);
  }
  .search-item .si-name{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    flex:1;
  }
  .search-item .si-rank{
    opacity:.7;
    flex:0 0 auto;
    font-size:12px;
  }
  .search-empty{
    padding:10px 12px;
    font-size:13px;
    opacity:.7;
  }

  /* Klik aman: pastikan elemen rank (emoji/angka) tidak ‚Äúnangkap‚Äù klik */
  .rank{ pointer-events:none; }

  /* Mobile: input full width & font kecil */
  @media (max-width: 640px){
    .data-head .head-search{ width:100%; }
    .data-head .head-search input{
      width:100%;
      min-width:unset;
      max-width:unset;
      font-size:12px;
      padding:8px 10px;
    }
    .data-body th, .data-body td{ font-size:12px; }
    .percent{ font-size:11px; min-width:40px; }
    .search-item{ font-size:12px; padding:10px; }
    .search-item .si-rank{ font-size:11px; }
    .data-body td:nth-child(2){ white-space:normal; } /* mobile boleh wrap sedikit */
  }

  
</style>

</head>

<body data-page="home">

<header class="topbar">
  <div class="topbar-inner">
    <a href="index.html" class="brand">
      <img src="assets/logo.png" class="brand-logo">
      <div class="brand-text">
        <div class="brand-title">Inspirasi BSI Scholarship</div>
        <div class="brand-batch">Batch 5</div>
      </div>
    </a>
    <button class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
    <nav class="nav" id="mobileNav">
      <a href="index.html" class="nav-link nav-link--active">Home</a>
      <a href="list-form.html" class="nav-link">List Form</a>
      <a href="rekap.html" class="nav-link">Rekap Aktivitas</a>
      <a href="ganti-nomor.html" class="nav-link">Kendala</a>
    </nav>
  </div>
</header>

<main class="page page--full">

<section class="hero hero--compact hero--dashboard">

    <div class="hero-badge">Hi, Sharia Young Leader!</div>

    <h1 class="hero-title">
        Bagaimana aktivitasmu hari ini?
    </h1>

    <p class="hero-subtitle">
        Ringkasan dihitung otomatis dari data rekap kehadiran awardee.
    </p>

    <!-- ACTION CARDS -->
    <div class="hero-card-grid">

        <!-- LIHAT SEMUA FORM -->
        <a href="list-form.html" class="hero-card hero-card--blue">
            <div class="hero-card-header">
                <svg class="hero-card-icon" viewBox="0 0 24 24">
                    <path d="M4 4h16v2H4zm0 5h16v2H4zm0 5h10v2H4z"/>
                </svg>
                <h3 class="hero-card-title">Lihat Semua Form</h3>
            </div>
            <p class="hero-card-text">
                Isi & cek seluruh form aktivitas.
            </p>
        </a>

        <!-- AWARDEE PORTAL -->
        <a href="https://sites.google.com/view/awardee-portal"
        class="hero-card hero-card--teal"
        target="_blank"
        rel="noopener noreferrer">
            <div class="hero-card-header">
                <svg class="hero-card-icon" viewBox="0 0 24 24">
                    <path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2c-4 0-8 2-8 5v3h16v-3c0-3-4-5-8-5z"/>
                </svg>
                <h3 class="hero-card-title">Awardee Portal</h3>
            </div>
            <p class="hero-card-text">
                Informasi & pembinaan resmi.
            </p>
        </a>

        <!-- REKAP AKTIVITAS -->
        <a href="rekap.html" class="hero-card hero-card--yellow">
            <div class="hero-card-header">
                <svg class="hero-card-icon" viewBox="0 0 24 24">
                    <path d="M3 17h3v-7H3zm5 0h3V7H8zm5 0h3v-4h-3zm5 0h3V4h-3z"/>
                </svg>
                <h3 class="hero-card-title">Rekap Aktivitas</h3>
            </div>
            <p class="hero-card-text">
                Detail kehadiran & evaluasi.
            </p>
        </a>

    </div>
</section>

<section class="kpi-grid">
  <div class="card card--kpi kpi-blue"><div>Total Awardee</div><strong id="kpiPeserta">‚Äî</strong></div>
  <div class="card card--kpi kpi-yellow"><div>Total Aktivitas</div><strong id="kpiAktivitas">‚Äî</strong></div>
  <div class="card card--kpi kpi-blue"><div>Rata-rata Kehadiran</div><strong id="kpiRate">‚Äî%</strong></div>
  <div class="card card--kpi kpi-yellow"><div>Total Kampus</div><strong id="kpiCampus">‚Äî</strong></div>
</section>

<section class="frame-2col">
  <div class="data-card">
    <div class="data-head good">
      <div class="head-title">üèÜ Top 10 Peserta Paling Aktif</div>
      <div class="head-search">
        <input id="searchPesertaTop" type="search" placeholder="Cari peserta..." autocomplete="off"
               oninput="showSuggestions('peserta','top',this)" onfocus="showSuggestions('peserta','top',this)">
        <div class="search-dropdown" hidden></div>
      </div>
    </div>
    <div class="data-body"><table id="tblPesertaTop"></table></div>
  </div>
  <div class="data-card">
    <div class="data-head bad">
      <div class="head-title">üìï Top 10 Peserta Kurang Aktif</div>
      <div class="head-search">
        <input id="searchPesertaLow" type="search" placeholder="Cari peserta..." autocomplete="off"
               oninput="showSuggestions('peserta','low',this)" onfocus="showSuggestions('peserta','low',this)">
        <div class="search-dropdown" hidden></div>
      </div>
    </div>
    <div class="data-body"><table id="tblPesertaLow"></table></div>
  </div>

  <div class="data-card">
    <div class="data-head good">
      <div class="head-title">üè´ Top 10 Kampus Paling Aktif</div>
      <div class="head-search">
        <input id="searchKampusTop" type="search" placeholder="Cari kampus..." autocomplete="off"
               oninput="showSuggestions('kampus','top',this)" onfocus="showSuggestions('kampus','top',this)">
        <div class="search-dropdown" hidden></div>
      </div>
    </div>
    <div class="data-body"><table id="tblKampusTop"></table></div>
  </div>
  <div class="data-card">
    <div class="data-head bad">
      <div class="head-title">üè´ Kampus Kurang Aktif</div>
      <div class="head-search">
        <input id="searchKampusLow" type="search" placeholder="Cari kampus..." autocomplete="off"
               oninput="showSuggestions('kampus','low',this)" onfocus="showSuggestions('kampus','low',this)">
        <div class="search-dropdown" hidden></div>
      </div>
    </div>
    <div class="data-body"><table id="tblKampusLow"></table></div>
  </div>

  <div class="data-card">
    <div class="data-head good">
      <div class="head-title">üë• Top 10 Kelompok Aktif</div>
      <div class="head-search">
        <input id="searchKelompokTop" type="search" placeholder="Cari kelompok..." autocomplete="off"
               oninput="showSuggestions('kelompok','top',this)" onfocus="showSuggestions('kelompok','top',this)">
        <div class="search-dropdown" hidden></div>
      </div>
    </div>
    <div class="data-body"><table id="tblKelompokTop"></table></div>
  </div>
  <div class="data-card">
    <div class="data-head bad">
      <div class="head-title">üë• Kelompok Kurang Aktif</div>
      <div class="head-search">
        <input id="searchKelompokLow" type="search" placeholder="Cari kelompok..." autocomplete="off"
               oninput="showSuggestions('kelompok','low',this)" onfocus="showSuggestions('kelompok','low',this)">
        <div class="search-dropdown" hidden></div>
      </div>
    </div>
    <div class="data-body"><table id="tblKelompokLow"></table></div>
  </div>
</section>

</main>

<nav class="mobile-bottom-nav">
  <a href="index.html" class="mb-item active">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z"/>
    </svg>
    <span class="mb-label">Home</span>
  </a>

  <a href="list-form.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M4 4h16v2H4V4zm0 5h16v2H4V9zm0 5h10v2H4v-2z"/>
    </svg>
    <span class="mb-label">List Form</span>
  </a>

  <a href="rekap.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M3 13h4v8H3v-8zm7-6h4v14h-4V7zm7-4h4v18h-4V3z"/>
    </svg>
    <span class="mb-label">Rekap</span>
  </a>

  <a href="ganti-nomor.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2c-4 0-8 2-8 5v3h16v-3c0-3-4-5-8-5z"/>
    </svg>
    <span class="mb-label">Kendala</span>
  </a>
</nav>

<footer class="footer">
  <div class="footer-inner">&copy; 2025 BSI Scholarship Hub</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/main.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const sb = window.supabaseClient;
  if (!sb) return;

  window.goRekap = function(type, value){
    window.location.href =
      `rekap.html?type=${type}&value=${encodeURIComponent(value)}`;
  }

  const PAGE = 1000;
  let from = 0, rows = [];

  while (true) {
    const { data } = await sb
      .from("rekap_bsi")
      .select("no_induk,nama,kampus,kelompok,pre_test,post_test,assessment,mentoring,pembinaan")
      .range(from, from + PAGE - 1);

    if (!data || !data.length) break;
    rows.push(...data);
    from += PAGE;
  }

  const isH = v => v === "‚úÖ" || v === "TP";
  const peserta = {};
  const kampus = {};
  const kelompok = {};
  let totalAct = 0, totalHad = 0;

  rows.forEach(r => {
    const hadir = [r.pre_test,r.post_test,r.assessment,r.mentoring,r.pembinaan].filter(isH).length;
    totalAct += 5;
    totalHad += hadir;

    peserta[r.no_induk] ??= { nama:r.nama, hadir:0, total:0 };
    peserta[r.no_induk].hadir += hadir; peserta[r.no_induk].total += 5;

    kampus[r.kampus] ??= { nama:r.kampus, hadir:0, total:0 };
    kampus[r.kampus].hadir += hadir; kampus[r.kampus].total += 5;

    kelompok[r.kelompok] ??= { nama:r.kelompok, hadir:0, total:0 };
    kelompok[r.kelompok].hadir += hadir; kelompok[r.kelompok].total += 5;
  });

  const sortFn = (a,b)=> (b.hadir/b.total)-(a.hadir/a.total) || b.hadir-a.hadir;

  const arrPeserta = Object.values(peserta).map(x=>({...x,rate:x.hadir/x.total})).sort(sortFn);
  const arrKampus  = Object.values(kampus).map(x=>({...x,rate:x.hadir/x.total})).sort(sortFn);
  const arrKelompok= Object.values(kelompok).map(x=>({...x,rate:x.hadir/x.total})).sort(sortFn);

  kpiPeserta.textContent = Object.keys(peserta).length;
  kpiAktivitas.textContent = totalAct;
  kpiRate.textContent = Math.round(totalHad/totalAct*100)+"%";
  kpiCampus.textContent = Object.keys(kampus).length;

  function render(el, arr, type, barClass){
    let h = "<tr><th>#</th><th>Nama</th><th>Hadir</th><th>Perc.</th></tr>";
    arr.slice(0,10).forEach((a,i)=>{
      const pct = Math.round(a.rate*100);
      const icon = i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":(i+1);

      h += `
      <tr class="click-row ${i<3?`top${i+1}`:""}"
          onclick="goRekap('${type}','${a.nama}')">
        <td class="center rank">${icon}</td>
        <td><strong>${a.nama}</strong></td>
        <td class="center">${a.hadir} dari ${a.total}</td>
        <td>
          <div class="progress-wrap">
            <div class="progress">
              <div class="${barClass}" style="width:${pct}%"></div>
            </div>
            <span class="percent">${pct}%</span>
          </div>
        </td>
      </tr>`;
    });
    el.innerHTML = h;
  }

  function renderSearchOne(el, item, type, barClass){
    const pct = Math.round(item.rate*100);
    const rankText = item.rank ?? "-";
    let h = "<tr><th>#</th><th>Nama</th><th>Hadir</th><th>Perc.</th></tr>";
    h += `
      <tr class="click-row"
          onclick="goRekap('${type}','${item.nama}')">
        <td class="center rank">${rankText}</td>
        <td><strong>${item.nama}</strong></td>
        <td class="center">${item.hadir} dari ${item.total}</td>
        <td>
          <div class="progress-wrap">
            <div class="progress">
              <div class="${barClass}" style="width:${pct}%"></div>
            </div>
            <span class="percent">${pct}%</span>
          </div>
        </td>
      </tr>
    `;
    el.innerHTML = h;
  }

  /* ‚úÖ SIMPAN RANK GLOBAL (dipakai suggestion, tidak mengubah logika utama) */
  window.__RANK_STORE__ = {
    peserta: arrPeserta.map((x,i)=>({ ...x, rank:i+1 })),
    kampus: arrKampus.map((x,i)=>({ ...x, rank:i+1 })),
    kelompok: arrKelompok.map((x,i)=>({ ...x, rank:i+1 })),
  };

  /* ‚úÖ Render top/bottom tetap seperti sebelumnya */
  render(tblPesertaTop, arrPeserta, "peserta", "good-bar");
  render(tblPesertaLow, arrPeserta.slice().reverse(), "peserta", "bad-bar");
  render(tblKampusTop, arrKampus, "kampus", "good-bar");
  render(tblKampusLow, arrKampus.slice().reverse(), "kampus", "bad-bar");
  render(tblKelompokTop, arrKelompok, "kelompok", "good-bar");
  render(tblKelompokLow, arrKelompok.slice().reverse(), "kelompok", "bad-bar");

  /* ===== Dropdown Suggestion (multi hasil) ===== */
  const limitSuggest = 15;

  function hideDropdown(dd){
    if(!dd) return;
    dd.hidden = true;
    dd.innerHTML = "";
  }

  function getTargetEl(kind, which){
    if(kind==="peserta" && which==="top") return tblPesertaTop;
    if(kind==="peserta" && which==="low") return tblPesertaLow;
    if(kind==="kampus" && which==="top") return tblKampusTop;
    if(kind==="kampus" && which==="low") return tblKampusLow;
    if(kind==="kelompok" && which==="top") return tblKelompokTop;
    return tblKelompokLow;
  }

  function resetTable(kind, which){
    if(kind==="peserta" && which==="top") return render(tblPesertaTop, arrPeserta, "peserta", "good-bar");
    if(kind==="peserta" && which==="low") return render(tblPesertaLow, arrPeserta.slice().reverse(), "peserta", "bad-bar");
    if(kind==="kampus" && which==="top") return render(tblKampusTop, arrKampus, "kampus", "good-bar");
    if(kind==="kampus" && which==="low") return render(tblKampusLow, arrKampus.slice().reverse(), "kampus", "bad-bar");
    if(kind==="kelompok" && which==="top") return render(tblKelompokTop, arrKelompok, "kelompok", "good-bar");
    if(kind==="kelompok" && which==="low") return render(tblKelompokLow, arrKelompok.slice().reverse(), "kelompok", "bad-bar");
  }

  window.showSuggestions = function(kind, which, input){
    const store = window.__RANK_STORE__;
    if(!store || !store[kind]) return;

    const q = (input.value || "").trim().toLowerCase();
    const dd = input.nextElementSibling;

    if(!q){
      hideDropdown(dd);
      resetTable(kind, which);
      return;
    }

    const matches = store[kind]
      .filter(x => (x.nama || "").toLowerCase().includes(q))
      .slice(0, limitSuggest);

    dd.innerHTML = "";

    if(!matches.length){
      dd.innerHTML = `<div class="search-empty">Tidak ditemukan</div>`;
      dd.hidden = false;
      return;
    }

    matches.forEach(item=>{
      const row = document.createElement("div");
      row.className = "search-item";
      row.innerHTML = `<div class="si-name">${item.nama}</div><div class="si-rank">Rank ${item.rank}</div>`;
      row.onclick = () => {
        const targetEl = getTargetEl(kind, which);
        const typeForRekap = (kind === "peserta") ? "peserta" : (kind === "kampus" ? "kampus" : "kelompok");
        const barClass = (which === "top") ? "good-bar" : "bad-bar";
        renderSearchOne(targetEl, item, typeForRekap, barClass);
        hideDropdown(dd);
      };
      dd.appendChild(row);
    });

    dd.hidden = false;
  };

  /* Klik di luar -> tutup dropdown */
  document.addEventListener("click", (e)=>{
    document.querySelectorAll(".search-dropdown").forEach(dd=>{
      const wrap = dd.parentElement;
      if(!wrap) return;
      if(!wrap.contains(e.target)) hideDropdown(dd);
    });
  });

});
</script>

</body>
</html>
