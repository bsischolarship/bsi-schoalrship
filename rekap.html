<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Rekap Aktivitas ‚Äî BSI Scholarship</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="assets/style.css" />
</head>

<body data-page="rekap">

<header class="topbar">
  <div class="topbar-inner">
    <a href="index.html" class="logo">
      <div class="logo-mark">üéì</div>
      <div>
        <div class="logo-text-main">BSI Scholarship</div>
        <div class="logo-text-sub">Sharia Young Leader</div>
      </div>
    </a>
    <button class="nav-toggle" aria-label="Toggle menu" onclick="toggleNav()">
        ‚ò∞
    </button>
    <nav class="nav" id="mobileNav">
        <a href="index.html" class="nav-link">Home</a>
        <a href="list-form.html" class="nav-link">List Form</a>
        <a href="rekap.html" class="nav-link nav-link--active">Rekap Aktivitas</a>
        <a href="ganti-nomor.html" class="nav-link">Ganti Nomor</a>
    </nav>
  </div>
</header>

<main class="page">

  <!-- HERO -->
  <section class="hero hero--compact">
    <h1>Rekap Progress Awardee</h1>
    <p>Rekapitulasi kehadiran dan keaktifan di semua kegiatan.</p>
  </section>

  <!-- KPI -->
  <section class="kpi-row">
    <div class="kpi-box kpi-blue">
      <span>Total Awardee</span>
      <strong id="kpiTotal">0</strong>
    </div>
    <div class="kpi-box kpi-green">
      <span>Pre-Test</span>
      <strong id="kpiPre">0%</strong>
    </div>
    <div class="kpi-box kpi-teal">
      <span>Post-Test</span>
      <strong id="kpiPost">0%</strong>
    </div>
    <div class="kpi-box kpi-orange">
      <span>Assessment</span>
      <strong id="kpiAssessment">0%</strong>
    </div>
    <div class="kpi-box kpi-indigo">
      <span>Mentoring</span>
      <strong id="kpiMentoring">0%</strong>
    </div>
  </section>

  <!-- FILTER -->
  <section class="card">
    <div class="filter-grid">
    <input id="fNoInduk" list="listNoInduk" placeholder="No Induk" />
    <input id="fNama" list="listNama" placeholder="Nama" />
    <input id="fKampus" list="listKampus" placeholder="Kampus" />
    <datalist id="listNoInduk"></datalist>
    <datalist id="listNama"></datalist>
    <datalist id="listKampus"></datalist>
      <select id="fPeriode">
        <option value="">Semua Periode</option>
      </select>
      <button class="btn-reset" onclick="resetFilter()">Reset</button>
    </div>
  </section>

  <!-- TABLE -->
  <section class="card">
    <h2>Rekap Detail</h2>

    <div class="table-wrap">
      <table class="rekap-table">
        <thead>
          <tr>
            <th>No Induk</th>
            <th>Nama</th>
            <th>Kampus</th>
            <th>Bulan</th>
            <th>Pre Test</th>
            <th>Post Test</th>
            <th>Assessment</th>
            <th>Mentoring</th>
          </tr>
        </thead>
        <tbody id="rekapBody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button onclick="goFirst()">First</button>
      <button onclick="goPrev()">Prev</button>
      <span id="pageInfo"></span>
      <button onclick="goNext()">Next</button>
      <button onclick="goLast()">Last</button>
    </div>
  </section>

</main>

<footer class="footer">
  <div class="footer-inner">¬© 2025 BSI Scholarship Hub</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://iyfwaqwmnmjfagszttts.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZndhcXdtbm1qZmFnc3p0dHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTEwMTgsImV4cCI6MjA4MzQyNzAxOH0.f2xb_aQDIj4tIPKwTTC9dgIi-9qFv0G252T5uo9XwXo";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGE_SIZE = 20;
let rawData = [];
let filteredData = [];
let currentPage = 1;

/* ================= UTIL ================= */
function monthLabel(d) {
  const [y, m] = d.split("-");
  const M = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  return `${M[m-1]} ${y}`;
}
function icon(v) {
  const val = String(v).trim();

  if (val === "‚úÖ") {
    return '<span class="icon icon-yes">‚úÖ</span>';
  }

  if (val === "TP") {
    return '<span class="icon icon-tp">TP</span>';
  }

  return '<span class="icon icon-no">‚ùå</span>';
}
function distinctAwardee(rows) {
  return new Set(rows.map(r => r.no_induk)).size;
}

/* ================= KPI ================= */
function renderKPI(rows) {
  const total = rows.length || 1;

  const countOK = k =>
    rows.filter(r => r[k] === "‚úÖ" || r[k] === "TP").length;

  kpiTotal.textContent = distinctAwardee(rows);
  kpiPre.textContent = Math.round(countOK("pre_test") / total * 100) + "%";
  kpiPost.textContent = Math.round(countOK("post_test") / total * 100) + "%";
  kpiAssessment.textContent = Math.round(countOK("assessment") / total * 100) + "%";
  kpiMentoring.textContent = Math.round(countOK("mentoring") / total * 100) + "%";
}


/* ================= TABLE ================= */
function renderTable() {
  const body = document.getElementById("rekapBody");
  body.innerHTML = "";

  const start = (currentPage - 1) * PAGE_SIZE;
  const rows = filteredData.slice(start, start + PAGE_SIZE);

  rows.forEach(r => {
    body.innerHTML += `
      <tr>
        <td>${r.no_induk}</td>
        <td class="td-bold">${r.nama}</td>
        <td>${r.kampus}</td>
        <td>${monthLabel(r.tanggal)}</td>
        <td>${icon(r.pre_test)}</td>
        <td>${icon(r.post_test)}</td>
        <td>${icon(r.assessment)}</td>
        <td>${icon(r.mentoring)}</td>
      </tr>
    `;
  });

  updatePageInfo();
}

function updatePageInfo() {
  const max = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
  pageInfo.textContent = `Page ${currentPage} / ${max}`;
}

/* ================= FILTER ================= */
function applyFilter() {
  filteredData = rawData.filter(r =>
    (!fNoInduk.value || r.no_induk.includes(fNoInduk.value)) &&
    (!fNama.value || r.nama.toLowerCase().includes(fNama.value.toLowerCase())) &&
    (!fKampus.value || r.kampus.toLowerCase().includes(fKampus.value.toLowerCase())) &&
    (!fPeriode.value || monthLabel(r.tanggal) === fPeriode.value)
  );
  currentPage = 1;
  renderKPI(filteredData);
  renderTable();
}

function resetFilter() {
  fNoInduk.value = "";
  fNama.value = "";
  fKampus.value = "";
  fPeriode.value = "";
  applyFilter();
}

/* ================= PAGINATION ================= */
function goFirst(){ currentPage = 1; renderTable(); }
function goPrev(){ if(currentPage>1){currentPage--; renderTable();} }
function goNext(){
  if(currentPage < Math.ceil(filteredData.length / PAGE_SIZE)){
    currentPage++; renderTable();
  }
}
function goLast(){
  currentPage = Math.ceil(filteredData.length / PAGE_SIZE);
  renderTable();
}

/* ================= LOAD ALL DATA ================= */
async function loadAllRows() {
  let all = [];
  let from = 0;
  const size = 1000;

  while (true) {
    const { data, error } = await supabaseClient
      .from("rekap_bsi")
      .select("no_induk,nama,kampus,tanggal,pre_test,post_test,assessment,mentoring")
      .range(from, from + size - 1);

    if (error || !data || data.length === 0) break;

    all = all.concat(data);
    if (data.length < size) break;
    from += size;
  }

  return all;
}

function fillDropdowns(rows) {
  const uniq = (arr) => [...new Set(arr)].sort();

  const noIndukList = uniq(rows.map(r => r.no_induk));
  const namaList = uniq(rows.map(r => r.nama));
  const kampusList = uniq(rows.map(r => r.kampus));

  const setOptions = (id, values) => {
    const el = document.getElementById(id);
    el.innerHTML = "";
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      el.appendChild(opt);
    });
  };

  setOptions("listNoInduk", noIndukList);
  setOptions("listNama", namaList);
  setOptions("listKampus", kampusList);
}


async function init() {
  rawData = await loadAllRows();
  filteredData = rawData;

  [...new Set(rawData.map(r => monthLabel(r.tanggal)))]
    .forEach(p => fPeriode.add(new Option(p, p)));
    fillDropdowns(rawData);
  applyFilter();
}

[fNoInduk, fNama, fKampus, fPeriode].forEach(el =>
  el.addEventListener("input", () => setTimeout(applyFilter, 150))
);

init();
</script>

</body>
</html>
