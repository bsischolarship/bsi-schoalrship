<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekap | Inspirasi BSI Scholarship — Batch 5</title>
    <link rel="stylesheet" href="assets/style.css" />
</head>

<body data-page="rekap">

<header class="topbar">
  <div class="topbar-inner">
        <a href="index.html" class="brand">
            <img src="assets/logo.png" alt="BSI Scholarship Logo" class="brand-logo">
            <div class="brand-text">
                <div class="brand-title">Inspirasi BSI Scholarship</div>
                <div class="brand-batch">Batch 5</div>
            </div>
        </a>

    <button class="nav-toggle" aria-label="Toggle menu" onclick="toggleNav()">☰</button>

    <nav class="nav" id="mobileNav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="list-form.html" class="nav-link">List Form</a>
      <a href="rekap.html" class="nav-link nav-link--active">Rekap Aktivitas</a>
      <a href="ganti-nomor.html" class="nav-link">Kendala</a>
    </nav>
  </div>
</header>

<main class="page">

  <!-- HERO -->
  <section class="hero hero--compact">
    <h1>Rekap Progress Awardee</h1>
    <p>Rekapitulasi kehadiran dan keaktifan seluruh awardee.</p>
  </section>

  <!-- KPI -->
  <section class="kpi-row kpi-6">
    <div class="kpi-box kpi-blues"><span>Total Awardee</span><strong id="kpiTotal">0</strong></div>
    <div class="kpi-box kpi-green"><span>Pre-Test</span><strong id="kpiPre">0%</strong></div>
    <div class="kpi-box kpi-teal"><span>Post-Test</span><strong id="kpiPost">0%</strong></div>
    <div class="kpi-box kpi-orange"><span>Assessment</span><strong id="kpiAssessment">0%</strong></div>
    <div class="kpi-box kpi-indigo"><span>Mentoring</span><strong id="kpiMentoring">0%</strong></div>
    <div class="kpi-box kpi-purple"><span>Pembinaan</span><strong id="kpiPembinaan">0%</strong></div>
  </section>

  <!-- FILTER -->
  <section class="card">
    <div class="filter-grid">
      <input id="fNoInduk" placeholder="No Induk" autocomplete="off" />
      <input id="fNama" placeholder="Nama" autocomplete="off" />
      <input id="fKampus" placeholder="Kampus" autocomplete="off" />
      <input id="fKelompok" placeholder="Kelompok" autocomplete="off" />

      <select id="fPeriode">
        <option value="">Semua Periode</option>
      </select>

      <button class="btn-reset" onclick="resetFilter()">Reset</button>
    </div>
  </section>

  <!-- TABLE -->
  <section class="card">
    <h2>Rekap Detail</h2>

    <div class="table-wrap">
      <table class="rekap-table">
        <thead>
          <tr>
            <th>No Induk</th>
            <th>Nama</th>
            <th>Kampus</th>
            <th>Kelompok</th>
            <th>Bulan</th>
            <th>Pre Test</th>
            <th>Post Test</th>
            <th>Assessment</th>
            <th>Mentoring</th>
            <th>Pembinaan</th>
          </tr>
        </thead>
        <tbody id="rekapBody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button onclick="goFirst()">First</button>
      <button onclick="goPrev()">Prev</button>
      <span id="pageInfo"></span>
      <button onclick="goNext()">Next</button>
      <button onclick="goLast()">Last</button>
    </div>
  </section>

</main>

<footer class="footer">
  <div class="footer-inner">© 2025 BSI Scholarship Hub</div>
</footer>

<!-- GLOBAL AUTOCOMPLETE -->
<div id="globalSuggest" class="suggestion-global"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= NAV ================= */
function toggleNav() {
  document.getElementById("mobileNav").classList.toggle("nav-open");
}

document.addEventListener("click", function (e) {
  const nav = document.getElementById("mobileNav");
  const toggle = document.querySelector(".nav-toggle");

  if (!nav.contains(e.target) && !toggle.contains(e.target)) {
    nav.classList.remove("nav-open");
  }
});

window.addEventListener("resize", () => {
  if (window.innerWidth > 768) {
    document.getElementById("mobileNav").classList.remove("nav-open");
  }
});

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://iyfwaqwmnmjfagszttts.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZndhcXdtbm1qZmFnc3p0dHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTEwMTgsImV4cCI6MjA4MzQyNzAxOH0.f2xb_aQDIj4tIPKwTTC9dgIi-9qFv0G252T5uo9XwXo";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGE_SIZE = 20;
let rawData = [];
let filteredData = [];
let currentPage = 1;

/* ================= URL FILTER (FROM HOME) ================= */
const _qs = new URLSearchParams(window.location.search);
const _filterType = (_qs.get("type") || "").trim().toLowerCase();   // peserta | kampus | kelompok
const _filterValue = (_qs.get("value") || "").trim();

/* ================= UTIL ================= */
function monthLabel(d) {
  const [y, m] = d.split("-");
  const M = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  return `${M[m-1]} ${y}`;
}

function icon(v) {
  const val = String(v).trim();

  if (val === "✅") {
    return `<td class="td-center cell-yes">✅</td>`;
  }

  if (val === "TP") {
    return `<td class="td-center cell-tp">TP</td>`;
  }

  return `<td class="td-center cell-no">❌</td>`;
}

/* ================= AUTOCOMPLETE ================= */
const globalSuggest = document.getElementById("globalSuggest");

function setupSuggest(input, values) {
  input.addEventListener("input", () => {
    const q = input.value.toLowerCase().trim();
    globalSuggest.innerHTML = "";

    if (!q) {
      globalSuggest.style.display = "none";
      applyFilter();
      return;
    }

    const match = values.filter(v =>
      v.toLowerCase().includes(q)
    ).slice(0, 12);

    if (!match.length) {
      globalSuggest.style.display = "none";
      applyFilter();
      return;
    }

    match.forEach(v => {
      const div = document.createElement("div");
      div.textContent = v;
      div.onclick = () => {
        input.value = v;
        globalSuggest.style.display = "none";
        applyFilter();
      };
      globalSuggest.appendChild(div);
    });

    const rect = input.getBoundingClientRect();
    globalSuggest.style.left = rect.left + "px";
    globalSuggest.style.top = rect.bottom + window.scrollY + "px";
    globalSuggest.style.width = rect.width + "px";
    globalSuggest.style.display = "block";

    applyFilter();
  });
}

document.addEventListener("click", (e) => {
  if (!globalSuggest.contains(e.target)) {
    globalSuggest.style.display = "none";
  }
});

/* ================= KPI ================= */
function renderKPI(rows) {
  const awardee = new Set(rows.map(r => r.no_induk)).size || 0;
  const ok = k => rows.filter(r => r[k] === "✅" || r[k] === "TP").length;

  const totalRows = rows.length || 1;

  kpiTotal.textContent = awardee;
  kpiPre.textContent = Math.round(ok("pre_test") / totalRows * 100) + "%";
  kpiPost.textContent = Math.round(ok("post_test") / totalRows * 100) + "%";
  kpiAssessment.textContent = Math.round(ok("assessment") / totalRows * 100) + "%";
  kpiMentoring.textContent = Math.round(ok("mentoring") / totalRows * 100) + "%";
  kpiPembinaan.textContent = Math.round(ok("pembinaan") / totalRows * 100) + "%";
}

/* ================= TABLE ================= */
function renderTable() {
  rekapBody.innerHTML = "";

  const start = (currentPage - 1) * PAGE_SIZE;
  const rows = filteredData.slice(start, start + PAGE_SIZE);

  rows.forEach(r => {
        rekapBody.innerHTML += `
        <tr>
            <td>${r.no_induk}</td>
            <td class="td-bold">${r.nama}</td>
            <td>${r.kampus}</td>
            <td>${r.kelompok}</td>
            <td>${monthLabel(r.tanggal)}</td>
            ${icon(r.pre_test)}
            ${icon(r.post_test)}
            ${icon(r.assessment)}
            ${icon(r.mentoring)}
            ${icon(r.pembinaan)}
        </tr>
        `;
  });

  pageInfo.textContent =
    `Page ${currentPage} / ${Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE))}`;
}

/* ================= FILTER ================= */
function applyFilter() {
  filteredData = rawData
    .filter(r =>
      (!fNoInduk.value || (r.no_induk || "").includes(fNoInduk.value)) &&
      (!fNama.value || (r.nama || "").toLowerCase().includes(fNama.value.toLowerCase())) &&
      (!fKampus.value || (r.kampus || "").toLowerCase().includes(fKampus.value.toLowerCase())) &&
      (!fKelompok.value || (r.kelompok || "").toLowerCase().includes(fKelompok.value.toLowerCase())) &&
      (!fPeriode.value || monthLabel(r.tanggal) === fPeriode.value)
    )
    // SORT A–Z by Nama
    .sort((a, b) => (a.nama || "").localeCompare((b.nama || ""), "id"));

  currentPage = 1;
  renderKPI(filteredData);
  renderTable();
}

function resetFilter() {
  fNoInduk.value = "";
  fNama.value = "";
  fKampus.value = "";
  fKelompok.value = "";
  fPeriode.value = "";
  applyFilter();

  // opsional: bersihkan query string agar kembali "normal"
  // history.replaceState(null, "", "rekap.html");
}

/* ================= PAGINATION ================= */
function goFirst(){ currentPage = 1; renderTable(); }
function goPrev(){ if(currentPage > 1){ currentPage--; renderTable(); } }
function goNext(){
  const maxPage = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
  if(currentPage < maxPage){
    currentPage++;
    renderTable();
  }
}
function goLast(){
  currentPage = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
  renderTable();
}

/* ================= LOAD DATA ================= */
async function init() {
  let all = [];
  let from = 0;

  while (true) {
    const { data, error } = await supabaseClient
      .from("rekap_bsi")
      .select("no_induk,nama,kampus,kelompok,tanggal,pre_test,post_test,assessment,mentoring,pembinaan")
      .range(from, from + 999);

    if (error || !data || !data.length) break;

    all = all.concat(data);
    if (data.length < 1000) break;
    from += 1000;
  }

  rawData = filteredData = all;

  setupSuggest(fNoInduk, [...new Set(all.map(r => (r.no_induk || "")).filter(Boolean))]);
  setupSuggest(fNama, [...new Set(all.map(r => (r.nama || "")).filter(Boolean))]);
  setupSuggest(fKampus, [...new Set(all.map(r => (r.kampus || "")).filter(Boolean))]);
  setupSuggest(fKelompok, [...new Set(all.map(r => (r.kelompok || "")).filter(Boolean))]);

  [...new Set(all.map(r => monthLabel(r.tanggal)))]
    .sort((a,b) => {
      // sort periode: "Mon YYYY" naive -> keep as-is if you prefer
      // biar konsisten, kita urutkan alfabet dulu (tetap ringan)
      return a.localeCompare(b, "id");
    })
    .forEach(p => fPeriode.add(new Option(p, p)));

  /* ================= AUTO-FILL FILTER FROM HOME ================= */
  if (_filterType && _filterValue) {
    // value dari URL harus aman (decode)
    const v = decodeURIComponent(_filterValue);

    if (_filterType === "peserta") {
      // best effort: isi Nama; jika Home nanti kirim no_induk, tetap bisa dicari di Nama via includes? (tidak), tapi default Home kirim nama.
      fNama.value = v;
    } else if (_filterType === "kampus") {
      fKampus.value = v;
    } else if (_filterType === "kelompok") {
      fKelompok.value = v;
    }
  }

  applyFilter();
}

fPeriode.addEventListener("change", applyFilter);

init();
</script>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-bottom-nav">
  <a href="index.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z"/>
    </svg>
    <span class="mb-label">Home</span>
  </a>

  <a href="list-form.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M4 4h16v2H4V4zm0 5h16v2H4V9zm0 5h10v2H4v-2z"/>
    </svg>
    <span class="mb-label">List Form</span>
  </a>

  <a href="rekap.html" class="mb-item active">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M3 13h4v8H3v-8zm7-6h4v14h-4V7zm7-4h4v18h-4V3z"/>
    </svg>
    <span class="mb-label">Rekap</span>
  </a>

  <a href="ganti-nomor.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2c-4 0-8 2-8 5v3h16v-3c0-3-4-5-8-5z"/>
    </svg>
    <span class="mb-label">Kendala</span>
  </a>
</nav>

</body>
</html>
