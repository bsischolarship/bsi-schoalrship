<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Rekap Aktivitas â€” BSI Scholarship</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body data-page="rekap">

<header class="topbar">
  <div class="topbar-inner">
    <a href="index.html" class="logo">
      <div class="logo-mark">ðŸŽ“</div>
      <div>
        <div class="logo-text-main">BSI Scholarship</div>
        <div class="logo-text-sub">Sharia Young Leader</div>
      </div>
    </a>

    <button class="nav-toggle" onclick="toggleNav()">â˜°</button>

    <nav class="nav" id="mobileNav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="list-form.html" class="nav-link">List Form</a>
      <a href="rekap.html" class="nav-link nav-link--active">Rekap Aktivitas</a>
      <a href="ganti-nomor.html" class="nav-link">Ganti Nomor</a>
    </nav>
  </div>
</header>

<main class="page">

  <!-- HERO -->
  <section class="hero hero--compact">
    <h1>Rekap Progress Awardee</h1>
    <p>Rekapitulasi kehadiran dan keaktifan seluruh awardee.</p>
  </section>

  <!-- KPI -->
  <section class="kpi-row">
    <div class="kpi-box kpi-blue">
      <span>Total Awardee</span>
      <strong id="kpiTotal">0</strong>
    </div>
    <div class="kpi-box kpi-green">
      <span>Pre-Test</span>
      <strong id="kpiPre">0%</strong>
    </div>
    <div class="kpi-box kpi-teal">
      <span>Post-Test</span>
      <strong id="kpiPost">0%</strong>
    </div>
    <div class="kpi-box kpi-orange">
      <span>Assessment</span>
      <strong id="kpiAssessment">0%</strong>
    </div>
    <div class="kpi-box kpi-indigo">
      <span>Mentoring</span>
      <strong id="kpiMentoring">0%</strong>
    </div>
  </section>

  <!-- FILTER -->
  <section class="card">
    <div class="filter-grid">

      <input id="fNoInduk" placeholder="No Induk" autocomplete="off" />
      <input id="fNama" placeholder="Nama" autocomplete="off" />
      <input id="fKampus" placeholder="Kampus" autocomplete="off" />

      <!-- Periode FIX dropdown -->
      <select id="fPeriode">
        <option value="">Semua Periode</option>
      </select>

      <button class="btn-reset" onclick="resetFilter()">Reset</button>
    </div>
  </section>

  <!-- TABLE -->
  <section class="card">
    <h2>Rekap Detail</h2>

    <div class="table-wrap">
      <table class="rekap-table">
        <thead>
          <tr>
            <th>No Induk</th>
            <th>Nama</th>
            <th>Kampus</th>
            <th>Bulan</th>
            <th>Pre</th>
            <th>Post</th>
            <th>Assessment</th>
            <th>Mentoring</th>
          </tr>
        </thead>
        <tbody id="rekapBody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button onclick="goFirst()">First</button>
      <button onclick="goPrev()">Prev</button>
      <span id="pageInfo"></span>
      <button onclick="goNext()">Next</button>
      <button onclick="goLast()">Last</button>
    </div>
  </section>

</main>

<footer class="footer">
  <div class="footer-inner">Â© 2025 BSI Scholarship Hub</div>
</footer>

<!-- GLOBAL SUGGESTION (ANTI TERPOTONG) -->
<div id="globalSuggest" class="suggestion-global"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= NAV ================= */
function toggleNav() {
  document.getElementById("mobileNav").classList.toggle("nav-open");
}

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://iyfwaqwmnmjfagszttts.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZndhcXdtbm1qZmFnc3p0dHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTEwMTgsImV4cCI6MjA4MzQyNzAxOH0.f2xb_aQDIj4tIPKwTTC9dgIi-9qFv0G252T5uo9XwXo";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGE_SIZE = 20;
let rawData = [];
let filteredData = [];
let currentPage = 1;

/* ================= UTIL ================= */
function monthLabel(d) {
  const [y, m] = d.split("-");
  const M = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  return `${M[m-1]} ${y}`;
}
function icon(v) {
  if (v === "âœ…") return "âœ…";
  if (v === "TP") return "TP";
  return "âŒ";
}

/* ================= AUTOCOMPLETE GLOBAL ================= */
const globalSuggest = document.getElementById("globalSuggest");

function setupSuggest(input, values) {
  input.addEventListener("input", () => {
    const q = input.value.toLowerCase().trim();
    globalSuggest.innerHTML = "";

    if (!q) {
      globalSuggest.style.display = "none";
      return;
    }

    const match = values
      .filter(v => v.toLowerCase().includes(q))
      .slice(0, 12);

    if (!match.length) {
      globalSuggest.style.display = "none";
      return;
    }

    match.forEach(v => {
      const div = document.createElement("div");
      div.textContent = v;
      div.onclick = () => {
        input.value = v;
        globalSuggest.style.display = "none";
        applyFilter();
      };
      globalSuggest.appendChild(div);
    });

    const rect = input.getBoundingClientRect();
    globalSuggest.style.left = rect.left + "px";
    globalSuggest.style.top = rect.bottom + window.scrollY + "px";
    globalSuggest.style.width = rect.width + "px";
    globalSuggest.style.display = "block";
  });
}

document.addEventListener("click", (e) => {
  if (!globalSuggest.contains(e.target)) {
    globalSuggest.style.display = "none";
  }
});

/* ================= KPI ================= */
function renderKPI(rows) {
  const awardee = new Set(rows.map(r => r.no_induk)).size || 1;
  const ok = k => rows.filter(r => r[k] === "âœ…" || r[k] === "TP").length;

  kpiTotal.textContent = awardee;
  kpiPre.textContent = Math.round(ok("pre_test") / rows.length * 100 || 0) + "%";
  kpiPost.textContent = Math.round(ok("post_test") / rows.length * 100 || 0) + "%";
  kpiAssessment.textContent = Math.round(ok("assessment") / rows.length * 100 || 0) + "%";
  kpiMentoring.textContent = Math.round(ok("mentoring") / rows.length * 100 || 0) + "%";
}

/* ================= TABLE ================= */
function renderTable() {
  rekapBody.innerHTML = "";

  const start = (currentPage - 1) * PAGE_SIZE;
  const rows = filteredData.slice(start, start + PAGE_SIZE);

  rows.forEach(r => {
    rekapBody.innerHTML += `
      <tr>
        <td>${r.no_induk}</td>
        <td class="td-bold">${r.nama}</td>
        <td>${r.kampus}</td>
        <td>${monthLabel(r.tanggal)}</td>
        <td class="td-center">${icon(r.pre_test)}</td>
        <td class="td-center">${icon(r.post_test)}</td>
        <td class="td-center">${icon(r.assessment)}</td>
        <td class="td-center">${icon(r.mentoring)}</td>
      </tr>
    `;
  });

  pageInfo.textContent =
    `Page ${currentPage} / ${Math.ceil(filteredData.length / PAGE_SIZE) || 1}`;
}

/* ================= FILTER ================= */
function applyFilter() {
  filteredData = rawData.filter(r =>
    (!fNoInduk.value || r.no_induk.includes(fNoInduk.value)) &&
    (!fNama.value || r.nama.toLowerCase().includes(fNama.value.toLowerCase())) &&
    (!fKampus.value || r.kampus.toLowerCase().includes(fKampus.value.toLowerCase())) &&
    (!fPeriode.value || monthLabel(r.tanggal) === fPeriode.value)
  );

  currentPage = 1;
  renderKPI(filteredData);
  renderTable();
}

function resetFilter() {
  fNoInduk.value = "";
  fNama.value = "";
  fKampus.value = "";
  fPeriode.value = "";
  applyFilter();
}

/* ================= PAGINATION ================= */
function goFirst(){ currentPage = 1; renderTable(); }
function goPrev(){ if(currentPage > 1){ currentPage--; renderTable(); } }
function goNext(){
  if(currentPage < Math.ceil(filteredData.length / PAGE_SIZE)){
    currentPage++; renderTable();
  }
}
function goLast(){
  currentPage = Math.ceil(filteredData.length / PAGE_SIZE);
  renderTable();
}

/* ================= LOAD ================= */
async function init() {
  let all = [];
  let from = 0;

  while (true) {
    const { data } = await supabaseClient
      .from("rekap_bsi")
      .select("no_induk,nama,kampus,tanggal,pre_test,post_test,assessment,mentoring")
      .range(from, from + 999);

    if (!data || !data.length) break;
    all = all.concat(data);
    if (data.length < 1000) break;
    from += 1000;
  }

  rawData = filteredData = all;

  setupSuggest(fNoInduk, [...new Set(all.map(r => r.no_induk))]);
  setupSuggest(fNama, [...new Set(all.map(r => r.nama))]);
  setupSuggest(fKampus, [...new Set(all.map(r => r.kampus))]);

  [...new Set(all.map(r => monthLabel(r.tanggal)))]
    .forEach(p => fPeriode.add(new Option(p, p)));

  applyFilter();
}

init();
</script>

</body>
</html>
