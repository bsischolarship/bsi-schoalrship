<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekap | Inspirasi BSI Scholarship — Batch 5</title>
    <link rel="stylesheet" href="assets/style.css" />

    <!-- ===== TAMBAHAN STYLE (TIDAK MENGHAPUS STYLE ANDA) ===== -->
    <style>
      /* Wrapper dropdown periode agar sejajar dengan input lain */
      .periode-dropdown {
        position: relative;
        width: 100%;
      }

      /* Tombol tampilannya mirip input (tidak makan tempat, tidak wrap) */
      .periode-btn {
        width: 100%;
        height: 44px;
        padding: 0 14px;
        border-radius: 14px;
        border: 1px solid #cfd6e4;
        background: #fff;
        font-size: 14px;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .periode-btn .periode-btn-label {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .periode-btn .periode-btn-caret {
        flex: 0 0 auto;
        opacity: 0.7;
      }

      /* Panel overlay (tidak mendorong layout, mobile aman) */
      .periode-panel {
        display: none;
        position: absolute;
        top: 52px;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #cfd6e4;
        border-radius: 14px;
        max-height: 220px;
        overflow-y: auto;
        z-index: 999;
        padding: 8px;
      }

      .periode-panel.open {
        display: block;
      }

      /* Item dibuat <label> biar KLIK di seluruh box */
      .periode-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        user-select: none;
        width: 100%;
      }

      .periode-item:hover {
        background: #f3f6fb;
      }

      .periode-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
        flex: 0 0 auto;
        accent-color: #00a79d;
      }

      .periode-item span {
        flex: 1;
        min-width: 0;
        white-space: nowrap;       /* cegah "Des ↵ 2025" */
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Header kecil di panel (opsional tapi rapi) */
      .periode-panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 6px 8px 10px;
        border-bottom: 1px solid #e6ebf3;
        margin-bottom: 8px;
      }

      .periode-panel-title {
        font-size: 12px;
        opacity: 0.75;
        white-space: nowrap;
      }

      .periode-panel-actions {
        display: flex;
        gap: 8px;
      }

      .periode-mini-btn {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid #d7deea;
        background: #fff;
        cursor: pointer;
        white-space: nowrap;
      }

      .periode-mini-btn:hover {
        background: #f3f6fb;
      }


    /* ===== FIX: agar dropdown tidak terpotong ===== */
    .card,
    .filter-grid {
      overflow: visible !important;
    }

    .periode-panel {
      z-index: 9999 !important;
    }

    .periode-panel {
      margin-top: 4px;
    }

    /* ===== FILTER GRID PROPORSI BARU ===== */
    .filter-grid {
      display: grid;
      grid-template-columns:
        1.2fr   /* No Induk (lebih pendek) */
        1.6fr   /* Nama */
        1.6fr   /* Kampus */
        1.2fr   /* Kelompok (lebih pendek) */
        2.4fr;  /* Periode (PALING PANJANG) */
      gap: 14px;
    }

    .periode-dropdown,
    .periode-btn {
      width: 100%;
    }

    @media (max-width: 768px) {
      .filter-grid {
        grid-template-columns: 1fr; /* stack */
      }
    }

/* ===== BASE BADGE ===== */
.status-badge {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  line-height: 1;
  box-sizing: border-box;
}

/* ===== CHECK (HIJAU SUCCESS) ===== */
.status-ok {
  background: #e9f7ef;          /* soft green highlight */
  border: 2px solid #22c55e;    /* green-500 */
}

.status-ok::after {
  content: "✓";
  position: absolute;
  color: #16a34a;               /* green-600 */
  font-size: 14px;
  font-weight: 800;
  line-height: 1;
  transform: translateY(-1px);
}


/* ===== CROSS (MERAH) ===== */
.status-no {
  background: #fdeaea;          /* highlight merah */
  border: 2px solid #ef4444;
}

.status-no::after {
  content: "×";
  position: absolute;
  color: #ef4444;
  font-size: 16px;
  font-weight: 800;
  line-height: 1;
  transform: translateY(-1px); /* optical centering */
}

/* ===== TP (NETRAL / KUNING ABU) ===== */
.status-tp {
  background: #fef9e7;          /* highlight kuning */
  border: 2px solid #f59e0b;
  color: #92400e;
  font-size: 10px;
  font-weight: 700;
}


.btn-report{
  padding:6px 10px;
  font-size:12px;
  font-weight:600;
  border-radius:8px;
  background:#f1f5ff;
  color:#1f3c88;
  border:1px solid #c7d2fe;
  text-decoration:none;
}

.btn-report:hover{
  background:#1f3c88;
  color:#fff;
}


      /* Mobile: panel tetap overlay, max-height lebih pendek */
      @media (max-width: 768px) {
        .periode-panel {
          max-height: 200px;
        }
      }
    </style>
</head>

<body data-page="rekap">

<header class="topbar">
  <div class="topbar-inner">
        <a href="index.html" class="brand">
            <img src="assets/logo.png" alt="BSI Scholarship Logo" class="brand-logo">
            <div class="brand-text">
                <div class="brand-title">Inspirasi BSI Scholarship</div>
                <div class="brand-batch">Batch 5</div>
            </div>
        </a>

    <button class="nav-toggle" aria-label="Toggle menu" onclick="toggleNav()">☰</button>

    <nav class="nav" id="mobileNav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="list-form.html" class="nav-link">List Form</a>
      <a href="rekap.html" class="nav-link nav-link--active">Rekap Aktivitas</a>
      <a href="ganti-nomor.html" class="nav-link">Kendala</a>
    </nav>
  </div>
</header>

<main class="page">

  <!-- HERO -->
  <section class="hero hero--compact">
    <h1>Rekap Progress Awardee</h1>
    <p>Rekapitulasi kehadiran dan keaktifan seluruh awardee.</p>
  </section>

  <!-- KPI -->
  <section class="kpi-row kpi-6">
    <div class="kpi-box kpi-blues"><span>Total Awardee</span><strong id="kpiTotal">0</strong></div>
    <div class="kpi-box kpi-green"><span>Pre-Test</span><strong id="kpiPre">0%</strong></div>
    <div class="kpi-box kpi-teal"><span>Post-Test</span><strong id="kpiPost">0%</strong></div>
    <div class="kpi-box kpi-orange"><span>Assessment</span><strong id="kpiAssessment">0%</strong></div>
    <div class="kpi-box kpi-indigo"><span>Mentoring</span><strong id="kpiMentoring">0%</strong></div>
    <div class="kpi-box kpi-purple"><span>Pembinaan</span><strong id="kpiPembinaan">0%</strong></div>
  </section>

  <!-- FILTER -->
  <section class="card">
    <div class="filter-grid">
      <input id="fNoInduk" placeholder="No Induk" autocomplete="off" />
      <input id="fNama" placeholder="Nama" autocomplete="off" />
      <input id="fKampus" placeholder="Kampus" autocomplete="off" />
      <input id="fKelompok" placeholder="Kelompok" autocomplete="off" />

      <!-- ===== PERIODE (DARI SELECT → DROPDOWN MULTI-CHECKBOX) ===== -->
      <!-- Saya tetap pertahankan SELECT asli (hidden) agar tidak merusak struktur lama, -->
      <!-- tetapi UI yang dipakai adalah dropdown custom. -->
      <select id="fPeriode" style="display:none;">
        <option value="">Semua Periode</option>
      </select>

      <div class="periode-dropdown" id="periodeDropdown">
        <button type="button" class="periode-btn" id="periodeBtn" aria-haspopup="listbox" aria-expanded="false">
          <span class="periode-btn-label" id="periodeBtnLabel">Semua Periode</span>
          <span class="periode-btn-caret">▼</span>
        </button>
        <div class="periode-panel" id="periodePanel">
          <div class="periode-panel-head">
            <div class="periode-panel-title">Pilih Periode</div>
            <div class="periode-panel-actions">
              <button type="button" class="periode-mini-btn" id="periodeSelectAll">All</button>
              <button type="button" class="periode-mini-btn" id="periodeClear">Clear</button>
            </div>
          </div>
          <div id="periodeList"></div>
        </div>
      </div>

      <button class="btn-reset" onclick="resetFilter()">Reset</button>
    </div>
  </section>

  <!-- TABLE -->
  <section class="card">
    <h2>Rekap Detail</h2>

    <div class="table-wrap">
      <table class="rekap-table">
        <thead>
          <tr>
            <th>No Induk</th>
            <th>Nama</th>
            <th>Kampus</th>
            <th>Kel</th>
            <th>Bulan</th>
            <th>Pre Test</th>
            <th>Post Test</th>
            <th>Assessment</th>
            <th>Mentoring</th>
            <th>Pembinaan</th>
            <th>Report</th>
          </tr>
        </thead>
        <tbody id="rekapBody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button onclick="goFirst()">First</button>
      <button onclick="goPrev()">Prev</button>
      <span id="pageInfo"></span>
      <button onclick="goNext()">Next</button>
      <button onclick="goLast()">Last</button>
    </div>
  </section>

</main>

<footer class="footer">
  <div class="footer-inner">© 2025 BSI Scholarship Hub</div>
</footer>

<!-- GLOBAL AUTOCOMPLETE -->
<div id="globalSuggest" class="suggestion-global"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= NAV ================= */
function toggleNav() {
  document.getElementById("mobileNav").classList.toggle("nav-open");
}

document.addEventListener("click", function (e) {
  const nav = document.getElementById("mobileNav");
  const toggle = document.querySelector(".nav-toggle");

  if (!nav.contains(e.target) && !toggle.contains(e.target)) {
    nav.classList.remove("nav-open");
  }
});

window.addEventListener("resize", () => {
  if (window.innerWidth > 768) {
    document.getElementById("mobileNav").classList.remove("nav-open");
  }
});

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://iyfwaqwmnmjfagszttts.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZndhcXdtbm1qZmFnc3p0dHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTEwMTgsImV4cCI6MjA4MzQyNzAxOH0.f2xb_aQDIj4tIPKwTTC9dgIi-9qFv0G252T5uo9XwXo";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGE_SIZE = 20;
let rawData = [];
let filteredData = [];
let currentPage = 1;

/* ================= MULTI PERIODE STATE ================= */
let selectedPeriode = [];

/* ================= URL FILTER (FROM HOME) ================= */
const _qs = new URLSearchParams(window.location.search);
const _filterType = (_qs.get("type") || "").trim().toLowerCase();   // peserta | kampus | kelompok
const _filterValue = (_qs.get("value") || "").trim();

/* ================= UTIL ================= */
function monthLabel(d) {
  const [y, m] = d.split("-");
  const M = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  return `${M[m-1]} ${y}`;
}

function icon(v) {
  const val = String(v).trim();

  if (val === "✅") {
    return `
      <td class="td-center">
        <span class="status-badge status-ok" title="Sudah lengkap"></span>
      </td>`;
  }

  if (val === "TP") {
    return `
      <td class="td-center">
        <span class="status-badge status-tp" title="Tidak perlu">TP</span>
      </td>`;
  }

  return `
    <td class="td-center">
      <span class="status-badge status-no" title="Belum"></span>
    </td>`;
}



/* ================= AUTOCOMPLETE ================= */
const globalSuggest = document.getElementById("globalSuggest");

function setupSuggest(input, values) {
  input.addEventListener("input", () => {
    const q = input.value.toLowerCase().trim();
    globalSuggest.innerHTML = "";

    if (!q) {
      globalSuggest.style.display = "none";
      applyFilter();
      return;
    }

    const match = values.filter(v =>
      v.toLowerCase().includes(q)
    ).slice(0, 12);

    if (!match.length) {
      globalSuggest.style.display = "none";
      applyFilter();
      return;
    }

    match.forEach(v => {
      const div = document.createElement("div");
      div.textContent = v;
      div.onclick = () => {
        input.value = v;
        globalSuggest.style.display = "none";
        applyFilter();
      };
      globalSuggest.appendChild(div);
    });

    const rect = input.getBoundingClientRect();
    globalSuggest.style.left = rect.left + "px";
    globalSuggest.style.top = rect.bottom + window.scrollY + "px";
    globalSuggest.style.width = rect.width + "px";
    globalSuggest.style.display = "block";

    applyFilter();
  });
}

document.addEventListener("click", (e) => {
  if (!globalSuggest.contains(e.target)) {
    globalSuggest.style.display = "none";
  }
});

/* ================= KPI ================= */
function renderKPI(rows) {
  const awardee = new Set(rows.map(r => r.no_induk)).size || 0;
  const ok = k => rows.filter(r => r[k] === "✅" || r[k] === "TP").length;

  const totalRows = rows.length || 1;

  kpiTotal.textContent = awardee;
  kpiPre.textContent = Math.round(ok("pre_test") / totalRows * 100) + "%";
  kpiPost.textContent = Math.round(ok("post_test") / totalRows * 100) + "%";
  kpiAssessment.textContent = Math.round(ok("assessment") / totalRows * 100) + "%";
  kpiMentoring.textContent = Math.round(ok("mentoring") / totalRows * 100) + "%";
  kpiPembinaan.textContent = Math.round(ok("pembinaan") / totalRows * 100) + "%";
}

/* ================= TABLE ================= */
function renderTable() {
  rekapBody.innerHTML = "";

  const start = (currentPage - 1) * PAGE_SIZE;
  const rows = filteredData.slice(start, start + PAGE_SIZE);

  rows.forEach(r => {
        rekapBody.innerHTML += `
        <tr>
            <td>${r.no_induk}</td>
            <td class="td-bold">${r.nama}</td>
            <td>${r.kampus}</td>
            <td>${r.kelompok}</td>
            <td>${monthLabel(r.tanggal)}</td>
            ${icon(r.pre_test)}
            ${icon(r.post_test)}
            ${icon(r.assessment)}
            ${icon(r.mentoring)}
            ${icon(r.pembinaan)}
            <td class="td-center">
            <a
              class="btn-report"
              href="report_pdfs/${monthLabel(r.tanggal)}/${r.no_induk}.pdf"
              target="_blank"
            >
              View Report
            </a>
          </td>
        </tr>
        `;
  });

  pageInfo.textContent =
    `Page ${currentPage} / ${Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE))}`;



}

/* ================= MULTI PERIODE UI HELPERS ================= */
function updatePeriodeBtnLabel() {
  const labelEl = document.getElementById("periodeBtnLabel");
  if (!selectedPeriode.length) {
    labelEl.textContent = "Semua Periode";
    return;
  }
  if (selectedPeriode.length === 1) {
    labelEl.textContent = selectedPeriode[0];
    return;
  }
  labelEl.textContent = `${selectedPeriode[0]} +${selectedPeriode.length - 1}`;
}

function syncHiddenSelect() {
  // hidden select tetap ada (compat), kita set selected biar konsisten
  const opts = Array.from(fPeriode.options);
  opts.forEach(o => {
    if (!o.value) return; // skip option "Semua Periode"
    o.selected = selectedPeriode.includes(o.value);
  });
}

function rebuildSelectedPeriodeFromChecks() {
  const checks = Array.from(document.querySelectorAll('#periodeList input[type="checkbox"]:checked'));
  selectedPeriode = checks.map(c => c.value);
  updatePeriodeBtnLabel();
  syncHiddenSelect();
}

/* ================= FILTER ================= */
function applyFilter() {
  filteredData = rawData
    .filter(r =>
      (!fNoInduk.value || (r.no_induk || "").includes(fNoInduk.value)) &&
      (!fNama.value || (r.nama || "").toLowerCase().includes(fNama.value.toLowerCase())) &&
      (!fKampus.value || (r.kampus || "").toLowerCase().includes(fKampus.value.toLowerCase())) &&
      (!fKelompok.value || (r.kelompok || "").toLowerCase().includes(fKelompok.value.toLowerCase())) &&
      (selectedPeriode.length === 0 || selectedPeriode.includes(monthLabel(r.tanggal)))
    )
    // SORT A–Z by Nama
    .sort((a, b) => (a.nama || "").localeCompare((b.nama || ""), "id"));

  currentPage = 1;
  renderKPI(filteredData);
  renderTable();
}

function resetFilter() {
  fNoInduk.value = "";
  fNama.value = "";
  fKampus.value = "";
  fKelompok.value = "";

  // reset hidden select juga
  fPeriode.value = "";

  // reset multi periode
  selectedPeriode = [];
  const checks = document.querySelectorAll('#periodeList input[type="checkbox"]');
  checks.forEach(c => c.checked = false);
  updatePeriodeBtnLabel();
  syncHiddenSelect();

  applyFilter();

  // opsional: bersihkan query string agar kembali "normal"
  // history.replaceState(null, "", "rekap.html");
}

/* ================= PAGINATION ================= */
function goFirst(){ currentPage = 1; renderTable(); }
function goPrev(){ if(currentPage > 1){ currentPage--; renderTable(); } }
function goNext(){
  const maxPage = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
  if(currentPage < maxPage){
    currentPage++;
    renderTable();
  }
}
function goLast(){
  currentPage = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
  renderTable();
}

/* ================= LOAD DATA ================= */
async function init() {
  let all = [];
  let from = 0;

  while (true) {
    const { data, error } = await supabaseClient
      .from("rekap_bsi")
      .select("no_induk,nama,kampus,kelompok,tanggal,pre_test,post_test,assessment,mentoring,pembinaan")
      .range(from, from + 999);

    if (error || !data || !data.length) break;

    all = all.concat(data);
    if (data.length < 1000) break;
    from += 1000;
  }

  rawData = filteredData = all;

  setupSuggest(fNoInduk, [...new Set(all.map(r => (r.no_induk || "")).filter(Boolean))]);
  setupSuggest(fNama, [...new Set(all.map(r => (r.nama || "")).filter(Boolean))]);
  setupSuggest(fKampus, [...new Set(all.map(r => (r.kampus || "")).filter(Boolean))]);
  setupSuggest(fKelompok, [...new Set(all.map(r => (r.kelompok || "")).filter(Boolean))]);

  /* ===== PERIODE SOURCE ===== */
  const periodeArr = [...new Set(all.map(r => monthLabel(r.tanggal)))]
    .sort((a,b) => {
      return a.localeCompare(b, "id");
    });

  /* ===== Populate hidden select (compat) ===== */
  // Pastikan option default tetap ada
  // Lalu tambahkan option periode
  periodeArr.forEach(p => fPeriode.add(new Option(p, p)));

  /* ===== Build custom checkbox list ===== */
  const list = document.getElementById("periodeList");
  list.innerHTML = "";

  periodeArr.forEach(p => {
    // <label> = klik di mana saja aktif
    const label = document.createElement("label");
    label.className = "periode-item";
    label.innerHTML = `
      <input type="checkbox" value="${p}">
      <span>${p}</span>
    `;
    // Saat klik label, checkbox auto toggle; kita cukup sync state di change
    const cb = label.querySelector("input");
    cb.addEventListener("change", () => {
      rebuildSelectedPeriodeFromChecks();
      applyFilter();
    });
    list.appendChild(label);
  });

  /* ===== Buttons All / Clear ===== */
  document.getElementById("periodeSelectAll").addEventListener("click", (e) => {
    e.stopPropagation();
    document.querySelectorAll('#periodeList input[type="checkbox"]').forEach(c => c.checked = true);
    rebuildSelectedPeriodeFromChecks();
    applyFilter();
  });

  document.getElementById("periodeClear").addEventListener("click", (e) => {
    e.stopPropagation();
    document.querySelectorAll('#periodeList input[type="checkbox"]').forEach(c => c.checked = false);
    rebuildSelectedPeriodeFromChecks();
    applyFilter();
  });

  /* ================= AUTO-FILL FILTER FROM HOME ================= */
  if (_filterType && _filterValue) {
    // value dari URL harus aman (decode)
    const v = decodeURIComponent(_filterValue);

    if (_filterType === "peserta") {
      // best effort: isi Nama; jika Home nanti kirim no_induk, tetap bisa dicari di Nama via includes? (tidak), tapi default Home kirim nama.
      fNama.value = v;
    } else if (_filterType === "kampus") {
      fKampus.value = v;
    } else if (_filterType === "kelompok") {
      fKelompok.value = v;
    }
  }

  // init label periode
  updatePeriodeBtnLabel();

  applyFilter();
}

/* ===== Dropdown open/close logic (mobile friendly) ===== */
const periodeBtn = document.getElementById("periodeBtn");
const periodePanel = document.getElementById("periodePanel");
const periodeDropdown = document.getElementById("periodeDropdown");

periodeBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  const isOpen = periodePanel.classList.toggle("open");
  periodeBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
});

document.addEventListener("click", (e) => {
  if (!periodeDropdown.contains(e.target)) {
    periodePanel.classList.remove("open");
    periodeBtn.setAttribute("aria-expanded", "false");
  }
});

/* ===== NOTE: sebelumnya ada listener fPeriode change. sekarang hidden select, tidak dipakai user langsung. ===== */
/* fPeriode.addEventListener("change", applyFilter); */

init();
</script>

<!-- MOBILE BOTTOM NAV -->
<nav class="mobile-bottom-nav">
  <a href="index.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5z"/>
    </svg>
    <span class="mb-label">Home</span>
  </a>

  <a href="list-form.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M4 4h16v2H4V4zm0 5h16v2H4V9zm0 5h10v2H4v-2z"/>
    </svg>
    <span class="mb-label">List Form</span>
  </a>

  <a href="rekap.html" class="mb-item active">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M3 13h4v8H3v-8zm7-6h4v14h-4V7zm7-4h4v18h-4V3z"/>
    </svg>
    <span class="mb-label">Rekap</span>
  </a>

  <a href="ganti-nomor.html" class="mb-item">
    <svg viewBox="0 0 24 24" class="mb-icon">
      <path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0 2c-4 0-8 2-8 5v3h16v-3c0-3-4-5-8-5z"/>
    </svg>
    <span class="mb-label">Kendala</span>
  </a>
</nav>

</body>
</html>
